<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Boundary Identification</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.vectorgrid/dist/Leaflet.VectorGrid.bundled.js"></script>
    <script src="https://unpkg.com/@turf/turf"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined">
    <link rel="stylesheet" href="style.css">
    <style>
        .language-dropdown {
            background-color: white;
            color: #1a202c; /* Dark text color */
        }

        .language-dropdown a:hover {
            background-color: green;
            color: white;
        }
         .dropdown-hidden {
            display: none;
        }

        .dropdown-visible {
            display: block;
        }
        .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background-color: #4a5568; /* Scrollbar thumb color */
            border-radius: 4px;
        }

        .dropdown-icon {
            transform: rotate(0deg);
            transition: transform 0.3s ease;
        }

        .dropdown-visible .dropdown-icon {
            transform: rotate(90deg);
        }
        .profile-section {
            cursor: pointer;
        }

        /* Sidebar icon and text alignment */
        .sidebar-item {
            display: flex;
            align-items: center;
        }

        .sidebar-item span {
            margin-right: 8px;
        }
      
    </style>
</head>
 <body class="bg-gradient-to-r from-purple-100 via-indigo-100 to-purple-200 min-h-screen flex flex-col">
    <header class="fixed top-0 left-0 w-full bg-green-600 p-4 z-40 flex justify-between items-center">
        <div class="flex items-center">
            <!-- Toggle button for mobile view (only visible on mobile) -->
            <button id="toggle-sidebar" class="lg:hidden text-white text-2xl focus:outline-none">
                <i class="fas fa-bars"></i>
            </button>
            <!-- Logo positioned near the toggle button (only visible on mobile) -->
            <div class="text-3xl font-bold text-white ml-2 lg:hidden">FarmVision</div>
        </div>
    
        <!-- Right side: Language selection and logout (only visible on mobile) -->
        <div class="flex items-center space-x-4 lg:hidden">
            <div class="relative group">
                <a href="#" class="text-white inline-flex items-center">EN
                    <i class="fa-solid fa-globe ml-1"></i>
                    <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </a>
                <div class="absolute hidden group-hover:block language-dropdown shadow-md mt-2 rounded whitespace-nowrap">
                    <a href="#" class="block px-4 py-2 hover:bg-green-600 hover:text-white">English</a>
                    <a href="#" class="block px-4 py-2 hover:bg-green-600 hover:text-white">Hindi</a>
                </div>
            </div>

            <a href="#" class="bg-green-600 text-white px-4 py-1 rounded border border-white hover:bg-green-700 transition transform hover:scale-105 focus:ring-2 focus:ring-white focus:ring-opacity-50">Logout</a>
          
        </div>
    
        <!-- Desktop Layout (hidden on mobile) -->
        <div class="hidden lg:flex items-center justify-between w-full">
            <div class="text-3xl font-bold text-white">FarmVision</div>
            <div class="flex items-center space-x-4">
                <div class="relative group">
                    <a href="#" class="text-white inline-flex items-center">EN
                        <i class="fa-solid fa-globe ml-1"></i>
                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </a>
                    <div class="absolute hidden group-hover:block language-dropdown shadow-md mt-2 rounded whitespace-nowrap">
                        <a href="#" class="block px-4 py-2 hover:bg-green-600 hover:text-white">English</a>
                        <a href="#" class="block px-4 py-2 hover:bg-green-600 hover:text-white">Hindi</a>
                    </div>
                </div>
                <a href="#" class="bg-green-600 text-white px-4 py-1 rounded border border-white hover:bg-green-700 transition transform hover:scale-105 focus:ring-2 focus:ring-white focus:ring-opacity-50">Logout</a>
            </div>
        </div>
    </header>


    <div>
        <nav id="sidebar" class="w-64 bg-gradient-to-r from-green-600 to-green-700 text-white p-4 fixed lg:block hidden lg:top-16 lg:left-0 lg:z-30 overflow-y-auto">
         <!-- Profile Section -->
         <div class="text-center profile-section" id="userDropdownToggle">
             <img src="https://github.com/mdo.png" alt="User Avatar" class="w-20 h-20 rounded-full mx-auto mb-2">
             <h5 class="text-sm font-bold">Saroj Nadar</h5>
             <p class="text-xs">Farm Manager</p>
     
             <!-- Profile Edit Option -->
             <a href="#" class="flex justify-center items-center mt-2 text-sm hover:text-gray-300">
                 <span class="material-symbols-outlined text-base mr-1">edit</span>
                 <span>Edit Profile</span>
             </a>
     
             <!-- User Dropdown -->
             <div id="userDropdown" class="hidden mt-2 bg-white text-gray-700 rounded-lg shadow-lg">
                 <a href="#" class="block px-4 py-2 hover:bg-green-600 hover:text-white">Profile</a>
                 <a href="#" class="block px-4 py-2 hover:bg-green-600 hover:text-white">Settings</a>
             </div>
         </div>
     
         <!-- Sidebar Menu -->
         <ul class="space-y-3 text-xs">
             <li>
                 <a href="#" class="sidebar-item flex items-center hover:bg-green-600 p-2 rounded-md transition">
                     <span class="material-symbols-outlined mr-3">home</span>
                     <span>Home</span>
                 </a>
             </li>
             <li>
                 <a href="#" class="sidebar-item flex items-center hover:bg-green-600 p-2 rounded-md transition">
                     <span class="material-symbols-outlined mr-3">dashboard</span>
                     <span>Dashboard</span>
                 </a>
             </li>
     
             <!-- Dropdown Menu 1 -->
             <li class="relative">
                 <a href="#" class="sidebar-item flex items-center justify-between hover:bg-green-600 p-2 rounded-md transition" onclick="toggleDropdown('menu1')">
                     <span class="flex items-center">
                         <span class="material-symbols-outlined mr-3">folder</span>
                         <span>View Farms</span>
                     </span>
                     <span class="fas fa-chevron-right dropdown-icon"></span>
                 </a>
                 <ul id="menu1" class="pl-6 mt-1 dropdown-hidden">
                     <li><a href="#" class="block py-2 hover:bg-green-600 rounded-md">Add New Farm</a></li>
                     <li><a href="#" class="block py-2 hover:bg-green-600 rounded-md">All Farms</a></li>
                 </ul>
             </li>
             <li>
                 <a href="#" class="sidebar-item flex items-center hover:bg-green-600 p-2 rounded-md transition">
                     <span class="material-symbols-outlined mr-3">agriculture</span>
                     <span>Track Crop Health</span>
                 </a>
             </li>
             <li>
                 <a href="#" class="sidebar-item flex items-center hover:bg-green-600 p-2 rounded-md transition">
                     <span class="material-symbols-outlined mr-3">water_drop</span>
                     <span>Track Soil Moisture</span>
                 </a>
             </li>
             <!-- New Menu Options -->
             <li>
                 <a href="#" class="sidebar-item flex items-center hover:bg-green-600 p-2 rounded-md transition">
                     <span class="material-symbols-outlined mr-3">water</span>
                     <span>Water Resource Info</span>
                 </a>
             </li>
             <li>
                 <a href="#" class="sidebar-item flex items-center hover:bg-green-600 p-2 rounded-md transition">
                     <span class="material-symbols-outlined mr-3">shield</span>
                     <span>Crop Insurance</span>
                 </a>
             </li>
             <li>
                 <a href="#" class="sidebar-item flex items-center hover:bg-green-600 p-2 rounded-md transition">
                     <span class="material-symbols-outlined mr-3">crop</span>
                     <span>CropZone Planning</span>
                 </a>
             </li>
             <li>
                 <a href="#" class="sidebar-item flex items-center hover:bg-green-600 p-2 rounded-md transition">
                     <span class="material-symbols-outlined mr-3">storefront</span>
                     <span>NearBy Traders</span>
                 </a>
             </li>
         </ul>
     </nav>
     </div>


     <main id="main-content" class="flex-1 bg-gray-50 p-8 lg:ml-64 mt-16">
        <div class="container mx-auto flex flex-col space-y-8">

            <!-- Form for village, khasra, and search -->
            <form id="searchForm" class="space-y-6">
                <div class="flex flex-col md:flex-row md:space-x-6 items-center">
                    <!-- Village Select -->
                    <div class="flex-grow mb-4 md:mb-0">
                        <label for="villageSelect" class="block text-lg font-semibold text-gray-800">Select Village:</label>
                        <select id="villageSelect" name="villageSelect"
                            class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">-- Select Village --</option>
                            {% for village in village_names %}
                                <option value="{{ village }}">{{ village }}</option>
                            {% endfor %}
                        </select>
                    </div>
    
                    <!-- Khasra Number Input -->
                    <div class="flex-grow mb-4 md:mb-0">
                        <label for="khasraInput" class="block text-lg font-semibold text-gray-800">Enter Khasra Number:</label>
                        <input type="text" id="khasraInput" name="khasraInput" placeholder="Khasra Number"
                            class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
    
                    <!-- Search Button -->
                    <div>
                        <button type="button" id="searchButton"
                            class="mt-5 px-6 py-3 bg-indigo-700 text-white rounded-md shadow-lg hover:bg-indigo-800 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                            Search
                        </button>
                    </div>
                </div>
            </form>
            
            <!-- Error and success messages -->
            <div id="errorMessage" class="text-red-600 font-semibold hidden text-center text-lg"></div>
            <div id="successMessage" class="text-green-600 font-semibold hidden text-center text-lg"></div>
    
            <!-- Map -->
            <div id="map" class="rounded-2xl shadow-lg h-96"></div>
    
            <!-- Area display centered with styling -->
            <div id="areaDisplay" class="mt-4 text-center text-3xl font-bold text-gray-800">
                Area: <span id="areaValue" class="text-indigo-600 font-bold text-4xl animate-pulse">0</span> acres
            </div>
    
            <!-- Farm Name and Save Button -->
            <form class="space-y-6">
                <div class="flex flex-col md:flex-row md:space-x-6 items-center">
                    <!-- Farm Name Input -->
                    <div class="flex-grow mb-4 md:mb-0">
                        <label for="farmNameInput" class="block text-lg font-semibold text-gray-800">Enter Farm Name:</label>
                        <input type="text" id="farmNameInput" name="farmNameInput" placeholder="Farm Name"
                            class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
    
                    <!-- Save Button -->
                    <div>
                        <button type="button" id="saveButton"
                            class="mt-5 px-6 py-3 bg-green-700 text-white rounded-md shadow-lg hover:bg-green-800 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300">
                            Save Farm
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </main>


    <script>
         function toggleDropdown(menuId) {
            const menu = document.getElementById(menuId);
            menu.classList.toggle('dropdown-hidden');
            menu.classList.toggle('dropdown-visible');
           }
                document.addEventListener('DOMContentLoaded', function () {
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.getElementById('toggle-sidebar');
            const mainContent = document.getElementById('main-content');
            const header = document.querySelector('header');

            function adjustLayout() {
                const headerHeight = header.offsetHeight;
                if (window.innerWidth >= 1024) { // lg breakpoint
                    sidebar.classList.remove('hidden');
                    sidebar.style.zIndex = '30';
                    sidebar.style.top = `${headerHeight}px`;
                    sidebar.style.height = `calc(100vh - ${headerHeight}px)`;
                    mainContent.style.marginLeft = '16rem'; // 64px
                } else {
                    sidebar.classList.add('hidden');
                    sidebar.style.zIndex = '50';
                    sidebar.style.top = `${headerHeight}px`;
                    sidebar.style.height = `calc(100vh - ${headerHeight}px)`;
                    mainContent.style.marginLeft = '0';
                }
            }


                // Initial adjustment
            adjustLayout();

            // Adjust on window resize
            window.addEventListener('resize', adjustLayout);

            toggleButton.addEventListener('click', function () {
                sidebar.classList.toggle('hidden');
                
                if (window.innerWidth < 1024) { // Only for mobile view
                    if (sidebar.classList.contains('hidden')) {
                        mainContent.style.marginLeft = '0';
                    } else {
                        sidebar.style.zIndex = '50';
                        mainContent.style.marginLeft = '0';
                    }
                }
            });
        });
        
        // Initialize the map
        var map = L.map('map').setView([26.591, 74.579], 15);
    
        // Add ESRI satellite layer as the base map
        L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; <a href="http://www.esri.com/">Esri</a>, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            maxZoom: 18,
        }).addTo(map);
    
        // Add the vector grid layer using protobuf format
        var vectorGridLayer = L.vectorGrid.protobuf('/farm/tiles/{z}/{x}/{y}.pbf', {
            maxZoom: 18,
            vectorTileLayerStyles: {
                'farmvision': {
                    fill: true,
                    fillColor: '#0000FF',
                    fillOpacity: 0.3,
                    color: '#0000FF',
                    weight: 1
                }
            },
            interactive: true,
            getFeatureId: function(feature) {
                return feature.properties.id;
            }
        }).addTo(map);
    
        // Handle click events on the vector grid layer
        vectorGridLayer.on('click', function(e) {
            var properties = e.layer.properties;
            var popupContent = '<b>Khasra No:</b> ' + (properties.Khasra_No || 'N/A') + '<br>' +
                            '<b>Village Name:</b> ' + (properties.Village_Na || 'N/A') + '<br>' +
                            '<b>Owner Name:</b> ' + (properties.Owner_s_Na || 'N/A') + '<br>' +
                            '<b>Classification:</b> ' + (properties.Classifica || 'N/A');
            L.popup()
                .setLatLng(e.latlng)
                .setContent(popupContent)
                .openOn(map);
        });
    
        // Variable to hold the currently highlighted polygon
        let currentPolygon = null;
        let polygonCoordinates = [];
        let currentArea = 0;
    
        // Function to display error messages
        function displayError(message) {
            const errorMessageElement = document.getElementById('errorMessage');
            errorMessageElement.innerText = message;
            errorMessageElement.classList.remove('hidden'); // Show the error message
        }

        // Function to display success messages
        function displaySuccess(message) {
            const successMessageElement = document.getElementById('successMessage');
            successMessageElement.innerText = message;
            successMessageElement.classList.remove('hidden'); // Show the success message
        }

        // Clear the messages
        function clearMessages() {
            const errorMessageElement = document.getElementById('errorMessage');
            const successMessageElement = document.getElementById('successMessage');

            errorMessageElement.innerText = '';
            successMessageElement.innerText = '';
            
            errorMessageElement.classList.add('hidden'); // Hide the error message
            successMessageElement.classList.add('hidden'); // Hide the success message
        }

        // Function to zoom to the specific Khasra number
        document.getElementById('searchButton').addEventListener('click', function() {
            clearMessages(); // Clear previous messages
            var village = document.getElementById('villageSelect').value;
            var khasraNumber = document.getElementById('khasraInput').value;

            if (!village || !khasraNumber) {
                displayError("Please select a village and enter a Khasra number.");
                return;
            }

            // Make an AJAX call to fetch the boundary for the selected Khasra number
            fetch(`/farm/get_boundary/?village=${encodeURIComponent(village)}&khasra=${encodeURIComponent(khasraNumber)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Boundary not found');
                    }
                    return response.json();
                })
                .then(data => {
                    // Clear the previous polygon if it exists
                    if (currentPolygon) {
                        map.removeLayer(currentPolygon);
                    }

                    // Zoom to the boundary coordinates received from the server
                    if (data && data.coordinates) {
                        var latlngs = data.coordinates.map(coord => [coord[1], coord[0]]);
                        polygonCoordinates = data.coordinates;  // Store coordinates for saving
                        currentPolygon = L.polygon(latlngs, { color: 'red' }).addTo(map);

                        // Convert the coordinates to GeoJSON format
                        var geoJsonPolygon = {
                            "type": "Polygon",
                            "coordinates": [data.coordinates]
                        };

                        // Calculate the area in square meters using Turf.js
                        var areaInSqMeters = turf.area(geoJsonPolygon);
                        currentArea = areaInSqMeters * 0.000247105; // Convert to acres

                        // Update the area display
                        document.getElementById('areaValue').innerText = currentArea.toFixed(2); // Display in acres

                        // Attach a popup to the polygon (optional)
                        currentPolygon.bindPopup("<b>Village Name:</b> " + village + "<br><b>Khasra Number:</b> " + khasraNumber);
                        currentPolygon.openPopup();

                        // Fit the map to the bounds of the new polygon
                        map.fitBounds(currentPolygon.getBounds());
                    }
                })
                .catch(error => {
                    displayError(error.message);
                });
        });

        // Save farm data
        document.getElementById('saveButton').addEventListener('click', function() {
            clearMessages(); // Clear previous messages
            var village = document.getElementById('villageSelect').value;
            var khasra = document.getElementById('khasraInput').value;
            var farmName = document.getElementById('farmNameInput').value;

            if (!village || !khasra || !farmName || !currentPolygon) {
                displayError("Please fill in all fields and ensure a polygon is selected.");
                return;
            }

            var area = currentArea.toFixed(2);  // Use the calculated area

            // Send the farm details and polygon coordinates to the server
            fetch('/farm/save_farm_details/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',  // Make sure CSRF token is correctly passed
                },
                body: JSON.stringify({
                    village: village,
                    khasra: khasra,
                    farm_name: farmName,
                    area: area,
                    polygon: polygonCoordinates.map(coord => [coord[0], coord[1]]),
                })
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    displaySuccess(data.success);
                    // Reset all fields after successful save
                    document.getElementById('villageSelect').value = '';
                    document.getElementById('khasraInput').value = '';
                    document.getElementById('farmNameInput').value = '';
                    if (currentPolygon) {
                        map.removeLayer(currentPolygon); // Remove the polygon from the map
                        currentPolygon = null; // Reset the currentPolygon variable
                    }
                    document.getElementById('areaValue').innerText = '0'; // Reset area display
                } else {
                    displayError(data.error);
                }
            })
            .catch(error => {
                displayError('An unexpected error occurred.');
            });
        });
    </script>       
</body>
</html>
